
services:
  zookeeper:
    image: bitnami/zookeeper:3.9
    environment: [ ALLOW_ANONYMOUS_LOGIN=yes ]
    ports: [ "2181:2181" ]

  kafka:
    image: bitnami/kafka:3.7
    ports: [ "9092:9092" ]
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - ALLOW_PLAINTEXT_LISTENER=yes
    depends_on: [ zookeeper ]

  user-db:
    image: postgres:16
    environment: [ POSTGRES_DB=userdb, POSTGRES_USER=user, POSTGRES_PASSWORD=user ]
    ports: [ "5433:5432" ]

  account-db:
    image: postgres:16
    environment: [ POSTGRES_DB=accountdb, POSTGRES_USER=account, POSTGRES_PASSWORD=account ]
    ports: [ "5434:5432" ]

  txn-db:
    image: postgres:16
    environment: [ POSTGRES_DB=txndb, POSTGRES_USER=txn, POSTGRES_PASSWORD=txn ]
    ports: [ "5435:5432" ]

  notify-db:
    image: postgres:16
    environment: [ POSTGRES_DB=notifydb, POSTGRES_USER=notify, POSTGRES_PASSWORD=notify ]
    ports: [ "5436:5432" ]

  api-gateway:
    build: ./api-gateway
    ports: [ "8080:8080" ]
    depends_on: [ user-service, account-service, transaction-service ]

  user-service:
    build: ./user-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://user-db:5432/userdb
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=user
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on: [ user-db, kafka ]

  account-service:
    build: ./account-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://account-db:5432/accountdb
      - SPRING_DATASOURCE_USERNAME=account
      - SPRING_DATASOURCE_PASSWORD=account
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on: [ account-db, kafka ]

  transaction-service:
    build: ./transaction-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://txn-db:5432/txndb
      - SPRING_DATASOURCE_USERNAME=txn
      - SPRING_DATASOURCE_PASSWORD=txn
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on: [ txn-db, kafka ]

  notification-service:
    build: ./notification-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://notify-db:5432/notifydb
      - SPRING_DATASOURCE_USERNAME=notify
      - SPRING_DATASOURCE_PASSWORD=notify
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on: [ notify-db, kafka ]
